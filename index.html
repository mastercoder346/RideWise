<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RideWise - Smart Mileage Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .slide-in { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Ping animation for location */
        @keyframes ping-slow {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        .animate-ping-slow {
            animation: ping-slow 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        /* Checkbox custom style */
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked + div {
            display: block;
        }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        accent: '#10b981',
                        danger: '#ef4444'
                    },
                    screens: {
                        'xs': '375px',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header (Optimized for Mobile) -->
    <header class="bg-white border-b border-slate-200 px-3 py-3 md:px-6 md:py-4 shadow-sm z-20">
        <div class="flex items-center justify-between gap-2">
            <!-- Left Side: Logo + Context -->
            <div class="flex items-center gap-2 flex-1 min-w-0">
                <div class="bg-primary/10 p-2 rounded-lg text-primary shrink-0 hidden md:block">
                    <i class="ph-fill ph-steering-wheel text-2xl"></i>
                </div>
                
                <div class="flex items-center gap-2 w-full max-w-[280px] md:max-w-none">
                    <h1 class="font-bold text-lg tracking-tight text-slate-900 hidden lg:block">RideWise</h1>
                    
                    <!-- Vehicle Selector Group -->
                    <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1 flex-1 md:flex-none md:w-auto min-w-0">
                        <div class="bg-white rounded-md p-1.5 text-primary md:hidden shrink-0">
                            <i class="ph-fill ph-car"></i>
                        </div>
                        <select id="vehicle-select" onchange="dataManager.switchVehicle(this.value)" class="bg-transparent text-sm font-semibold text-slate-700 outline-none border-none px-2 py-1 w-full md:w-[160px] cursor-pointer truncate min-w-0">
                            <!-- Options injected by JS -->
                        </select>
                        <button onclick="uiManager.openCarModal()" class="bg-white hover:bg-slate-200 text-slate-600 rounded-md p-1.5 shadow-sm transition-colors shrink-0" title="Add New Car">
                            <i class="ph-bold ph-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Side: Actions -->
            <div class="flex items-center gap-2 shrink-0">
                <!-- Maintenance Button -->
                <button onclick="uiManager.openServiceModal()" class="text-slate-400 hover:text-orange-500 p-2 transition-colors rounded-lg relative" title="Vehicle Maintenance">
                    <i class="ph-bold ph-wrench text-xl"></i>
                    <span id="service-badge" class="hidden absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>

                <!-- Data/Settings Button -->
                <button onclick="uiManager.openDataModal()" class="text-slate-400 hover:text-slate-700 p-2 transition-colors rounded-lg" title="Data & Settings">
                    <i class="ph-bold ph-gear text-xl"></i>
                </button>

                <!-- Primary Action: Add Log -->
                <button onclick="uiManager.openModal()" class="bg-slate-900 hover:bg-primary text-white text-sm font-medium px-3 py-2 md:px-5 md:py-2.5 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center gap-2 active:scale-95 whitespace-nowrap">
                    <i class="ph-bold ph-plus text-lg"></i>
                    <span class="hidden xs:inline">Add Log</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden p-3 md:p-6 lg:p-8 relative">
        <div class="max-w-6xl mx-auto space-y-4 md:space-y-6">
            
            <!-- Main Stats Grid (KPIs) -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 md:gap-4">
                <!-- Stat Card 1 -->
                <div class="bg-white p-3 md:p-5 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between h-24 md:h-32 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 p-2 md:p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="ph-fill ph-gauge text-4xl md:text-6xl text-primary"></i>
                    </div>
                    <p class="text-slate-500 text-[10px] md:text-sm font-medium uppercase tracking-wide whitespace-nowrap">Average MPG</p>
                    <div class="flex items-end gap-1 md:gap-2">
                        <h2 id="stat-mpg" class="text-xl md:text-3xl font-bold text-slate-800">--</h2>
                        <span class="text-[10px] md:text-xs text-slate-400 mb-1 md:mb-1.5">mi/gal</span>
                    </div>
                    <div id="stat-mpg-trend" class="text-[10px] md:text-xs font-medium mt-1 md:mt-2 flex items-center gap-1 truncate">
                        <!-- Dynamic content -->
                    </div>
                </div>

                <!-- Stat Card 2 -->
                <div class="bg-white p-3 md:p-5 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between h-24 md:h-32 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 p-2 md:p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="ph-fill ph-currency-dollar text-4xl md:text-6xl text-accent"></i>
                    </div>
                    <p class="text-slate-500 text-[10px] md:text-sm font-medium uppercase tracking-wide whitespace-nowrap">Cost / Mile</p>
                    <div class="flex items-end gap-1 md:gap-2">
                        <h2 id="stat-cpm" class="text-xl md:text-3xl font-bold text-slate-800">--</h2>
                        <span class="text-[10px] md:text-xs text-slate-400 mb-1 md:mb-1.5">$</span>
                    </div>
                </div>

                <!-- Stat Card 3 -->
                <div class="bg-white p-3 md:p-5 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between h-24 md:h-32 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 p-2 md:p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="ph-fill ph-piggy-bank text-4xl md:text-6xl text-yellow-500"></i>
                    </div>
                    <p class="text-slate-500 text-[10px] md:text-sm font-medium uppercase tracking-wide whitespace-nowrap">Total Saved</p>
                    <div class="flex items-end gap-1 md:gap-2">
                        <h2 id="stat-saved" class="text-xl md:text-3xl font-bold text-emerald-600">--</h2>
                        <span class="text-[10px] md:text-xs text-slate-400 mb-1 md:mb-1.5">USD</span>
                    </div>
                </div>

                <!-- Stat Card 4 -->
                <div class="bg-white p-3 md:p-5 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between h-24 md:h-32 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 p-2 md:p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="ph-fill ph-road-horizon text-4xl md:text-6xl text-indigo-500"></i>
                    </div>
                    <p class="text-slate-500 text-[10px] md:text-sm font-medium uppercase tracking-wide whitespace-nowrap">Total Dist</p>
                    <div class="flex items-end gap-1 md:gap-2">
                        <h2 id="stat-dist" class="text-xl md:text-3xl font-bold text-slate-800">--</h2>
                        <span class="text-[10px] md:text-xs text-slate-400 mb-1 md:mb-1.5">mi</span>
                    </div>
                </div>
            </div>

            <!-- Dashboard Split -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                
                <!-- Left: Detailed Statistics Overview -->
                <div class="lg:col-span-2 min-w-0 space-y-6">
                    
                    <!-- Stats Overview -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden flex flex-col">
                        <div class="p-4 md:p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 shrink-0">
                            <h3 class="font-semibold text-slate-700 flex items-center gap-2 text-sm md:text-base">
                                <i class="ph-fill ph-chart-bar text-primary"></i> Statistics Overview
                            </h3>
                        </div>
                        
                        <div class="p-3 md:p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 h-full">
                                <!-- 1. Monthly Section -->
                                <div class="bg-blue-50/40 rounded-xl border border-blue-100 p-4 flex flex-col justify-center relative overflow-hidden">
                                    <div class="absolute right-0 top-0 p-3 opacity-5">
                                        <i class="ph-fill ph-calendar text-6xl text-blue-600"></i>
                                    </div>
                                    <div class="flex items-center gap-2 mb-3 relative z-10">
                                        <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                                        <h4 class="text-xs font-bold text-blue-700 uppercase tracking-wider">This Month</h4>
                                    </div>
                                    <div class="grid grid-cols-2 gap-y-4 gap-x-2 relative z-10">
                                        <div>
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide mb-0.5">Distance</p>
                                            <p class="text-lg md:text-xl font-bold text-slate-800 leading-none tracking-tight" id="table-month-dist">--</p>
                                        </div>
                                        <div>
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide mb-0.5">Cost</p>
                                            <p class="text-lg md:text-xl font-bold text-slate-800 leading-none tracking-tight" id="table-month-cost">--</p>
                                        </div>
                                        <div>
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide mb-0.5">Fill-ups</p>
                                            <p class="text-lg md:text-xl font-bold text-slate-800 leading-none tracking-tight" id="table-month-fillups">--</p>
                                        </div>
                                        <div>
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide mb-0.5">MPG</p>
                                            <p class="text-lg md:text-xl font-bold text-blue-600 leading-none tracking-tight" id="table-month-mpg">--</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. Yearly Section -->
                                <div class="bg-indigo-50/40 rounded-xl border border-indigo-100 p-4 flex flex-col justify-center relative overflow-hidden">
                                    <div class="absolute right-0 top-0 p-3 opacity-5">
                                        <i class="ph-fill ph-calendar-check text-6xl text-indigo-600"></i>
                                    </div>
                                    <div class="flex items-center gap-2 mb-3 relative z-10">
                                        <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div>
                                        <h4 class="text-xs font-bold text-indigo-700 uppercase tracking-wider">Year to Date</h4>
                                    </div>
                                    <div class="grid grid-cols-2 gap-y-4 gap-x-2 relative z-10">
                                        <div>
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide mb-0.5">Distance</p>
                                            <p class="text-lg md:text-xl font-bold text-slate-800 leading-none tracking-tight" id="table-ytd-dist">--</p>
                                        </div>
                                        <div>
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide mb-0.5">Cost</p>
                                            <p class="text-lg md:text-xl font-bold text-slate-800 leading-none tracking-tight" id="table-ytd-cost">--</p>
                                        </div>
                                        <div>
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide mb-0.5">Fill-ups</p>
                                            <p class="text-lg md:text-xl font-bold text-slate-800 leading-none tracking-tight" id="table-ytd-fillups">--</p>
                                        </div>
                                        <div>
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide mb-0.5">MPG</p>
                                            <p class="text-lg md:text-xl font-bold text-indigo-600 leading-none tracking-tight" id="table-ytd-mpg">--</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 3. Lifetime Section -->
                                <div class="bg-slate-50/60 rounded-xl border border-slate-200 p-4 flex flex-col justify-center relative overflow-hidden">
                                    <div class="absolute right-0 top-0 p-3 opacity-5">
                                        <i class="ph-fill ph-infinity text-6xl text-slate-600"></i>
                                    </div>
                                    <div class="flex items-center gap-2 mb-4 relative z-10">
                                        <div class="w-1.5 h-1.5 rounded-full bg-slate-500"></div>
                                        <h4 class="text-xs font-bold text-slate-600 uppercase tracking-wider">Lifetime</h4>
                                    </div>
                                    <div class="space-y-3 relative z-10">
                                        <div class="flex justify-between items-end border-b border-slate-200 pb-1.5">
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase">Total Gallons</p>
                                            <p class="text-sm font-bold text-slate-800" id="table-total-gallons">--</p>
                                        </div>
                                        <div class="flex justify-between items-end border-b border-slate-200 pb-1.5">
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase">Avg Price/Gal</p>
                                            <p class="text-sm font-bold text-emerald-600" id="table-avg-price">--</p>
                                        </div>
                                        <div class="flex justify-between items-end">
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase">Total Fill-ups</p>
                                            <p class="text-sm font-bold text-slate-800" id="table-fillups">--</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 4. Insights & Records -->
                                <div class="bg-emerald-50/40 rounded-xl border border-emerald-100 p-4 flex flex-col justify-center relative overflow-hidden">
                                    <div class="absolute right-0 top-0 p-3 opacity-5">
                                        <i class="ph-fill ph-trophy text-6xl text-emerald-600"></i>
                                    </div>
                                    <div class="flex items-center gap-2 mb-4 relative z-10">
                                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                        <h4 class="text-xs font-bold text-emerald-700 uppercase tracking-wider">Records & Insights</h4>
                                    </div>
                                    <div class="space-y-3 relative z-10">
                                        <div class="flex justify-between items-end border-b border-emerald-100 pb-1.5">
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase">Best MPG</p>
                                            <p class="text-sm font-bold text-emerald-600" id="insight-best-mpg">--</p>
                                        </div>
                                        <div class="flex justify-between items-end border-b border-emerald-100 pb-1.5">
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase">Longest Range</p>
                                            <p class="text-sm font-bold text-slate-800" id="insight-best-range">--</p>
                                        </div>
                                        <div class="flex justify-between items-end border-b border-emerald-100 pb-1.5">
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase">Stop Frequency</p>
                                            <p class="text-sm font-bold text-slate-800" id="insight-freq">--</p>
                                        </div>
                                        <div class="flex justify-between items-end">
                                            <p class="text-[10px] text-slate-500 font-semibold uppercase">Est. Annual Cost</p>
                                            <p class="text-sm font-bold text-slate-800" id="insight-proj-cost">--</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Maintenance Health (New with Cost Tracker) -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-4 md:p-5 border-b border-slate-100 flex justify-between items-center bg-orange-50/30">
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold text-slate-700 flex items-center gap-2 text-sm md:text-base">
                                    <i class="ph-fill ph-wrench text-orange-500"></i> Vehicle Health
                                </h3>
                                <div class="text-[10px] text-orange-600 font-semibold bg-orange-100 px-2 py-0.5 rounded-full" id="health-total-cost">
                                    $0.00 Maint.
                                </div>
                            </div>
                            <button onclick="uiManager.openServiceModal()" class="text-xs text-blue-600 font-semibold hover:underline">Manage Services</button>
                        </div>
                        <div id="health-list" class="p-4 space-y-3">
                            <!-- JS Injected Content -->
                            <div class="text-center py-2 text-slate-400 text-xs italic">
                                No service tasks configured. Tap Manage.
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right: Recent History -->
                <div class="lg:col-span-1 min-w-0">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 h-full flex flex-col max-h-[500px] md:max-h-[600px]">
                        <div class="p-4 md:p-5 border-b border-slate-100 flex justify-between items-center shrink-0">
                            <h3 class="font-semibold text-slate-700 text-sm md:text-base">Recent Logs</h3>
                            <span id="entry-count" class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-full">0 entries</span>
                        </div>
                        <div id="history-list" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-2 md:space-y-3">
                            <!-- JS will inject entries here -->
                            <div class="text-center py-10 text-slate-400">
                                <i class="ph ph-notebook text-4xl mb-2"></i>
                                <p class="text-sm">No entries yet.<br>Click the + button to add one.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Small Bottom Spacer -->
        <div class="h-6"></div>
    </main>

    <!-- Modal Form: Add/Edit Fuel Entry -->
    <div id="entry-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="p-5 md:p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold text-slate-800">New Fuel Entry</h3>
                <button onclick="uiManager.closeModal()" class="text-slate-400 hover:text-slate-600 p-1">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            
            <form id="fuel-form" class="p-5 md:p-6 space-y-4 md:space-y-5">
                <input type="hidden" id="input-entry-id">

                <!-- Partial / Missed Toggles -->
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="input-partial" class="sr-only peer">
                        <div class="w-8 h-4 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-orange-400 relative"></div>
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Partial Tank</span>
                    </label>
                    
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="input-missed" class="sr-only peer">
                        <div class="w-8 h-4 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-red-400 relative"></div>
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Missed Previous</span>
                    </label>
                </div>

                <!-- Gas Station (With Geo-detect) -->
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold text-slate-500 uppercase">Gas Station</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input type="text" id="input-station" list="station-list" placeholder="e.g. Shell on Main St" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                            <datalist id="station-list">
                                <!-- Populated by JS -->
                            </datalist>
                        </div>
                        <button type="button" onclick="uiManager.detectLocation()" id="btn-location" class="bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg px-3 py-2 transition-colors relative" title="Find nearby station">
                            <i class="ph-fill ph-map-pin"></i>
                            <span id="loc-ping" class="absolute -top-1 -right-1 w-3 h-3 bg-primary rounded-full hidden animate-ping-slow"></span>
                        </button>
                    </div>
                </div>

                <!-- Date & Odometer Row -->
                <div class="grid grid-cols-2 gap-3 md:gap-4">
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Date</label>
                        <input type="date" id="input-date" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 md:px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Odometer</label>
                        <input type="number" id="input-odometer" placeholder="e.g., 45020" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                    </div>
                </div>

                <!-- Fuel Details -->
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold text-slate-500 uppercase">Gallons Filled</label>
                    <div class="relative">
                        <input type="number" step="0.001" id="input-gallons" placeholder="0.000" required class="w-full bg-slate-50 border border-slate-200 rounded-lg pl-3 pr-10 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        <span class="absolute right-3 top-2.5 text-slate-400 text-sm">gal</span>
                    </div>
                </div>

                <!-- Price Row -->
                <div class="grid grid-cols-2 gap-3 md:gap-4">
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Price / Gal</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-slate-400 text-sm">$</span>
                            <input type="number" step="0.001" id="input-price" placeholder="0.000" required class="w-full bg-slate-50 border border-slate-200 rounded-lg pl-7 pr-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold text-emerald-600 uppercase flex items-center gap-1">
                            Discount / Gal
                            <i class="ph-fill ph-tag text-emerald-500"></i>
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-emerald-500 text-sm">-$</span>
                            <input type="text" inputmode="numeric" id="input-discount" value="0.00" class="w-full bg-emerald-50 border border-emerald-200 text-emerald-800 rounded-lg pl-7 pr-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 font-medium">
                        </div>
                    </div>
                </div>
                
                <!-- Summary Preview -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 flex justify-between items-center">
                    <span class="text-xs text-slate-500">Estimated Total</span>
                    <span id="preview-total" class="font-bold text-slate-800 text-lg">$0.00</span>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="uiManager.deleteEntry()" id="btn-delete" class="hidden bg-red-50 hover:bg-red-100 text-red-600 font-medium py-3 px-4 rounded-xl transition-colors">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                    <button type="submit" id="btn-submit" class="flex-1 bg-slate-900 hover:bg-primary text-white font-medium py-3 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform active:scale-95">
                        Save Entry
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Form: Service Management -->
    <div id="service-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300 h-[90vh] md:h-auto md:max-h-[85vh] flex flex-col" id="service-modal-content">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-slate-800">Maintenance & Services</h3>
                <button onclick="uiManager.closeServiceModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-slate-100 px-5 shrink-0">
                <button onclick="uiManager.switchServiceTab('active')" id="tab-active" class="px-4 py-3 text-sm font-bold text-primary border-b-2 border-primary transition-colors">Active Trackers</button>
                <button onclick="uiManager.switchServiceTab('history')" id="tab-history" class="px-4 py-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-colors">History Log</button>
            </div>

            <div class="p-5 overflow-y-auto flex-1">
                <!-- Tab: Active Trackers -->
                <div id="view-active-services" class="space-y-5">
                    <!-- Add New Service -->
                    <form id="service-form" class="space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xs font-bold text-slate-500 uppercase">Add New Service Schedule</h4>
                        </div>
                        
                        <input type="text" id="input-svc-name" placeholder="Service Name (e.g. Oil Change)" required class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none">
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="space-y-1">
                                <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Repeat Every</label>
                                <input type="number" id="input-svc-interval" placeholder="e.g. 5000 miles" required class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Last Mileage</label>
                                <input type="number" id="input-svc-last" placeholder="Odometer" required class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none">
                            </div>
                        </div>

                        <!-- NEW: Optional Cost Field during setup -->
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Cost (Optional)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-slate-400 text-sm">$</span>
                                <input type="number" step="0.01" id="input-svc-initial-cost" placeholder="Enter cost if you just did this" class="w-full bg-white border border-slate-200 rounded-lg pl-6 pr-3 py-2 text-sm focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-slate-800 text-white text-sm font-medium py-2.5 rounded-lg hover:bg-slate-900 transition-colors shadow-sm">Save & Track</button>
                    </form>

                    <!-- Existing Services List -->
                    <div id="active-services-list" class="space-y-3">
                        <!-- JS Injected -->
                    </div>
                </div>

                <!-- Tab: History Log -->
                <div id="view-history-services" class="hidden space-y-3">
                    <div id="service-history-list" class="space-y-2">
                        <!-- JS Injected -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Form: Log Service Done (New) -->
    <div id="log-service-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[60] p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300" id="log-service-content">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">Log Service Record</h3>
                <button onclick="uiManager.closeLogServiceModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <form id="log-service-form" class="p-5 space-y-4">
                <input type="hidden" id="log-svc-id">
                
                <!-- Dynamic Name Field -->
                <div id="log-svc-name-container">
                    <label class="text-xs font-semibold text-slate-500 uppercase mb-1 block">Service Description</label>
                    <!-- Either a display box (for scheduled) or input (for one-off) will appear here -->
                    <input type="text" id="log-svc-custom-name" placeholder="e.g. New Battery" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-medium">
                    <div id="log-svc-static-name" class="hidden bg-blue-50 p-2.5 rounded-lg border border-blue-100 text-sm text-blue-800 font-bold"></div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-semibold text-slate-500 uppercase">Date</label>
                    <input type="date" id="log-svc-date" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Odometer</label>
                        <input type="number" id="log-svc-odo" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Cost ($)</label>
                        <input type="number" step="0.01" id="log-svc-cost" placeholder="0.00" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-semibold text-slate-500 uppercase">Notes (Optional)</label>
                    <input type="text" id="log-svc-note" placeholder="e.g. Used synthetic oil" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                </div>

                <button type="submit" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-3 rounded-xl shadow-md transition-all duration-300">
                    Save Record
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Form: Add Car -->
    <div id="car-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300" id="car-modal-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">Add Vehicle</h3>
                <button onclick="uiManager.closeCarModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            
            <form id="car-form" class="p-6 space-y-5">
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold text-slate-500 uppercase">Vehicle Name</label>
                    <input type="text" id="input-car-name" placeholder="e.g. Toyota Camry" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                </div>
                <button type="submit" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-3 rounded-xl shadow-md transition-all duration-300">
                    Add Vehicle
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Form: Data & Settings -->
    <div id="data-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300" id="data-modal-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">Data Management</h3>
                <button onclick="uiManager.closeDataModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Backup Section -->
                <div class="space-y-3">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Backup & Restore</h4>
                    <button onclick="dataManager.exportCSV()" class="w-full flex items-center justify-center gap-2 bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 font-medium py-3 rounded-xl transition-colors">
                        <i class="ph-bold ph-file-csv"></i> Export as CSV (Excel)
                    </button>
                    <button onclick="dataManager.exportData()" class="w-full flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-3 rounded-xl transition-colors">
                        <i class="ph-bold ph-download-simple"></i> Backup Data (JSON)
                    </button>
                    <button onclick="document.getElementById('input-import').click()" class="w-full flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-3 rounded-xl transition-colors">
                        <i class="ph-bold ph-upload-simple"></i> Restore Backup
                    </button>
                    <input type="file" id="input-import" accept=".json, .csv" class="hidden" onchange="dataManager.importData(this)">
                </div>

                <!-- Danger Zone -->
                <div class="pt-4 border-t border-slate-100 space-y-3">
                    <h4 class="text-xs font-bold text-red-400 uppercase tracking-wider">Danger Zone</h4>
                    <button onclick="dataManager.clearCurrentVehicleData()" class="w-full flex items-center justify-center gap-2 border border-red-100 text-red-500 hover:bg-red-50 font-medium py-3 rounded-xl transition-colors">
                        <i class="ph-bold ph-trash"></i> Clear Current Car Logs
                    </button>
                    <button onclick="dataManager.clearAllData()" class="w-full flex items-center justify-center gap-2 bg-red-50 text-red-600 hover:bg-red-100 font-medium py-3 rounded-xl transition-colors">
                        <i class="ph-bold ph-warning"></i> Reset Everything
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl z-[70] transition-all duration-300 translate-y-[-150%] flex items-center gap-2">
        <i class="ph-fill ph-check-circle text-accent"></i>
        <span class="text-sm font-medium" id="toast-msg">Success</span>
    </div>

    <!-- Logic -->
    <script>
        // --- Data Management ---
        const dataManager = {
            state: {
                vehicles: [],
                stations: [], 
                activeVehicleId: null
            },
            
            init() {
                try {
                    const stored = localStorage.getItem('fuelFlowData');
                    let parsed = null;
                    if (stored) {
                        try {
                            parsed = JSON.parse(stored);
                        } catch (e) {
                            console.warn("Corrupt data found, resetting.");
                        }
                    }
                    
                    if (parsed) {
                        if (Array.isArray(parsed)) {
                            const defaultCarId = Date.now();
                            this.state.vehicles = [{
                                id: defaultCarId,
                                name: "My Car",
                                entries: parsed,
                                services: [],
                                maintenanceLogs: []
                            }];
                            this.state.activeVehicleId = defaultCarId;
                            this.state.stations = [];
                            this.save();
                        } else if (parsed.vehicles && Array.isArray(parsed.vehicles) && parsed.vehicles.length > 0) {
                            this.state = parsed;
                            if (!this.state.stations) this.state.stations = [];
                            
                            // Ensure services & maintenance logs exist for older versions
                            this.state.vehicles.forEach(v => {
                                if (!v.services) v.services = [];
                                if (!v.maintenanceLogs) v.maintenanceLogs = [];
                            });

                            const hasActive = this.state.vehicles.some(v => v.id == this.state.activeVehicleId);
                            if (!hasActive || !this.state.activeVehicleId) {
                                this.state.activeVehicleId = this.state.vehicles[0].id;
                            }
                        } else {
                            throw new Error("Invalid data structure");
                        }
                    } else {
                        throw new Error("No data");
                    }
                } catch (e) {
                    const defaultId = Date.now();
                    this.state = {
                        vehicles: [{
                            id: defaultId,
                            name: "My Car",
                            entries: [],
                            services: [],
                            maintenanceLogs: []
                        }],
                        stations: [],
                        activeVehicleId: defaultId
                    };
                    this.save();
                }

                uiManager.initVehicleSelect();
                uiManager.render();
            },

            getActiveVehicle() {
                const vehicle = this.state.vehicles.find(v => v.id == this.state.activeVehicleId);
                return vehicle || this.state.vehicles[0];
            },

            addVehicle(name) {
                const newId = Date.now();
                const newVehicle = {
                    id: newId,
                    name: name,
                    entries: [],
                    services: [],
                    maintenanceLogs: []
                };
                this.state.vehicles.push(newVehicle);
                this.state.activeVehicleId = newId;
                this.save();
                uiManager.initVehicleSelect();
                uiManager.render();
                uiManager.showToast("Vehicle Added");
            },

            switchVehicle(id) {
                this.state.activeVehicleId = parseInt(id);
                this.save();
                uiManager.render();
            },

            upsertEntry(entry, coords) {
                const vehicle = this.getActiveVehicle();
                const index = vehicle.entries.findIndex(e => e.id === entry.id);
                
                if (index !== -1) {
                    vehicle.entries[index] = entry;
                } else {
                    vehicle.entries.push(entry);
                }

                vehicle.entries.sort((a, b) => b.odometer - a.odometer);
                
                if (entry.station) {
                    const existingStation = this.state.stations.find(s => s.name.toLowerCase() === entry.station.toLowerCase());
                    if (existingStation) {
                        if (index === -1) existingStation.uses++;
                    } else {
                        this.state.stations.push({ name: entry.station, uses: 1 });
                    }
                }

                this.save();
                uiManager.render();
                uiManager.showToast(index !== -1 ? "Entry Updated" : "Entry Saved");
            },

            deleteEntry(id) {
                const vehicle = this.getActiveVehicle();
                const initialLen = vehicle.entries.length;
                vehicle.entries = vehicle.entries.filter(e => e.id !== id);
                
                if (vehicle.entries.length < initialLen) {
                    this.save();
                    uiManager.render();
                    uiManager.showToast("Entry Deleted");
                }
            },

            // --- Service Management ---
            addService(name, interval, lastOdo, initialCost) {
                const vehicle = this.getActiveVehicle();
                if (!vehicle.services) vehicle.services = [];
                
                // 1. Create the Tracker
                const newServiceId = Date.now();
                vehicle.services.push({
                    id: newServiceId,
                    name,
                    interval: parseInt(interval),
                    lastOdo: parseInt(lastOdo)
                });

                // 2. If cost was provided, immediately create a history log
                if (initialCost && initialCost > 0) {
                    if (!vehicle.maintenanceLogs) vehicle.maintenanceLogs = [];
                    vehicle.maintenanceLogs.push({
                        id: Date.now() + 1, // Ensure slightly diff ID
                        serviceId: newServiceId,
                        serviceName: name,
                        date: new Date().toISOString().split('T')[0], // Today
                        odometer: parseInt(lastOdo),
                        cost: parseFloat(initialCost),
                        notes: "Initial Setup Entry"
                    });
                    // Re-sort logs
                    vehicle.maintenanceLogs.sort((a, b) => new Date(b.date) - new Date(a.date));
                }

                this.save();
                uiManager.renderServices();
                uiManager.renderHealthCard();
                uiManager.showToast("Service Tracker Added");
            },

            // Perform Service & Log Cost
            performService(serviceId, serviceName, date, odo, cost, notes) {
                const vehicle = this.getActiveVehicle();
                
                // If it's a tracked service, update the tracker
                if (serviceId) {
                    const svc = vehicle.services.find(s => s.id === serviceId);
                    if (svc) {
                        svc.lastOdo = parseInt(odo);
                    }
                }

                // Add to history log
                if (!vehicle.maintenanceLogs) vehicle.maintenanceLogs = [];
                
                let finalName = serviceName;
                if (serviceId) {
                     const svc = vehicle.services.find(s => s.id === serviceId);
                     if (svc) finalName = svc.name;
                }

                vehicle.maintenanceLogs.push({
                    id: Date.now(),
                    serviceId: serviceId, 
                    serviceName: finalName,
                    date: date,
                    odometer: parseInt(odo),
                    cost: parseFloat(cost) || 0,
                    notes: notes || ""
                });

                // Sort logs by date desc
                vehicle.maintenanceLogs.sort((a, b) => new Date(b.date) - new Date(a.date));

                this.save();
                uiManager.renderServices();
                uiManager.renderHealthCard(); 
                uiManager.showToast("Service Logged");
            },

            deleteService(id) {
                const vehicle = this.getActiveVehicle();
                vehicle.services = vehicle.services.filter(s => s.id !== id);
                this.save();
                uiManager.renderServices();
                uiManager.renderHealthCard();
            },

            // --- Backup & Restore ---
            exportData() {
                const dataStr = JSON.stringify(this.state, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                a.href = url;
                a.download = `ridewise_backup_${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                uiManager.showToast("JSON Exported");
            },

            exportCSV() {
                const vehicle = this.getActiveVehicle();
                if (vehicle.entries.length === 0) {
                    alert("No data to export for this vehicle.");
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Date,Odometer,Gallons,Price,Total Cost,Station,Partial Fill\n";

                vehicle.entries.forEach(e => {
                    const date = e.date;
                    const totalCost = (e.price - e.discount) * e.gallons;
                    const station = e.station ? e.station.replace(/,/g, "") : ""; 
                    const partial = e.isPartial ? "Yes" : "No";
                    
                    const row = `${date},${e.odometer},${e.gallons},${e.price},${totalCost.toFixed(2)},${station},${partial}`;
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `ridewise_${vehicle.name.replace(/\s+/g, '_')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                uiManager.showToast("CSV Exported");
            },

            importData(input) {
                const file = input.files[0];
                if (!file) return;

                // No confirm here, processCSVImport handles logic or we confirm inside JSON block
                // Actually, let's keep it simple: just read it.
                
                const isCSV = file.name.toLowerCase().endsWith('.csv');

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        if (isCSV) {
                            if(!confirm("Importing CSV will merge data into your CURRENTLY SELECTED vehicle. Continue?")) {
                                input.value = '';
                                return;
                            }
                            this.processCSVImport(e.target.result);
                        } else {
                            // JSON
                            const parsed = JSON.parse(e.target.result);
                            if (parsed.vehicles && Array.isArray(parsed.vehicles)) {
                                if(!confirm("Importing JSON will OVERWRITE ALL current data. Continue?")) {
                                    input.value = '';
                                    return;
                                }
                                this.state = parsed;
                                this.save();
                                uiManager.initVehicleSelect();
                                uiManager.render();
                                uiManager.closeDataModal();
                                uiManager.showToast("Data Restored Successfully");
                            } else {
                                alert("Invalid JSON backup file format.");
                            }
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error parsing file.");
                    }
                };
                reader.readAsText(file);
                input.value = ''; 
            },

            processCSVImport(csvText) {
                const lines = csvText.split(/\r\n|\n/).filter(l => l.trim().length > 0);
                if (lines.length < 2) {
                    alert("CSV file seems empty or invalid.");
                    return;
                }

                // 1. Find the Header Row
                let headerIdx = -1;
                let header = "";
                let rawHeader = "";
                
                // Looser search to find the "## Log" section or the header directly
                for (let i = 0; i < lines.length; i++) {
                    // Normalize line: lowercase, remove quotes for matching check
                    const checkLine = lines[i].toLowerCase().replace(/"/g, '');
                    
                    // Your file uses "Data" for date and "Odo (mi)"
                    // We check for "odo (mi)" AND ("data" OR "date") to be sure
                    if (checkLine.includes('odo (mi)') && (checkLine.includes('data') || checkLine.includes('date'))) {
                        headerIdx = i;
                        header = checkLine; // usage for indexing
                        rawHeader = lines[i]; // usage for splitting
                        break;
                    }
                }

                if (headerIdx === -1) {
                    alert("Could not auto-detect CSV header row.\nLooking for columns: 'Data' (or Date), 'Odo (mi)', 'Fuel'.");
                    return;
                }

                // 2. Map Columns
                // Use a robust split for the header to ensure indices match the data rows
                // Simple split by comma is usually fine for headers, but let's be safe
                const cols = rawHeader.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)
                             .map(c => c.toLowerCase().replace(/^"|"$/g, '').trim());

                const idxMap = {
                    // Support "Data" (your file) and "Date" (standard)
                    date: cols.findIndex(c => c === 'data' || c === 'date'),
                    odo: cols.findIndex(c => c.includes('odo') || c.includes('mileage')),
                    gal: cols.findIndex(c => c.includes('fuel') || c.includes('gallons') || c.includes('volume')),
                    pricePerGal: cols.findIndex(c => c === 'volumeprice' || c.includes('price/gal') || c.includes('unit cost')),
                    totalCost: cols.findIndex(c => c.includes('total cost') || (c.includes('price') && !c.includes('volume'))),
                    station: cols.findIndex(c => c.includes('city') || c.includes('station') || c.includes('brand')),
                    full: cols.findIndex(c => c === 'full' || c === 'partial'),
                    missed: cols.findIndex(c => c === 'missed' || c.includes('missed')),
                    notes: cols.findIndex(c => c.includes('notes') || c.includes('comment'))
                };

                if (idxMap.date === -1 || idxMap.odo === -1 || idxMap.gal === -1) {
                    alert(`Critical columns missing.\nFound indices: Date:${idxMap.date}, Odo:${idxMap.odo}, Gal:${idxMap.gal}`);
                    return;
                }

                let addedCount = 0;
                const vehicle = this.getActiveVehicle();

                // 3. Process Rows
                for (let i = headerIdx + 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // Robust CSV Line Splitter (Handles quotes with commas inside)
                    const matches = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    
                    if (!matches) continue;

                    // Clean quotes from values
                    const row = matches.map(m => m.replace(/^"|"$/g, '').trim());

                    if (row.length < 3) continue;

                    try {
                        // Parse Date
                        let dateRaw = row[idxMap.date];
                        // If format is "2025-11-14 12:22", new Date() usually handles it.
                        let dateObj = new Date(dateRaw);
                        
                        if (isNaN(dateObj.getTime())) {
                            // Try replacing space with T for ISO "2025-11-14T12:22" compatibility in stricter browsers
                            dateObj = new Date(dateRaw.replace(' ', 'T'));
                        }

                        if (isNaN(dateObj.getTime())) {
                            console.warn("Invalid date:", dateRaw);
                            continue;
                        }
                        
                        const finalDate = dateObj.toISOString().split('T')[0];

                        const odoRaw = parseFloat(row[idxMap.odo]);
                        const galRaw = parseFloat(row[idxMap.gal]);
                        
                        // Price Logic
                        let priceRaw = 0.0;
                        if (idxMap.pricePerGal !== -1 && row[idxMap.pricePerGal]) {
                            priceRaw = parseFloat(row[idxMap.pricePerGal]);
                        } else if (idxMap.totalCost !== -1 && row[idxMap.totalCost]) {
                            const total = parseFloat(row[idxMap.totalCost]);
                            if (!isNaN(total) && galRaw > 0) {
                                priceRaw = total / galRaw;
                            }
                        }

                        // Station Cleaning (Your file has "Cranbury BP - ")
                        let station = idxMap.station !== -1 ? row[idxMap.station] : "";
                        if (station.endsWith('-')) station = station.slice(0, -1).trim();

                        // Partial Logic
                        let isPartial = false;
                        if (idxMap.full !== -1) {
                            const fullVal = row[idxMap.full];
                            // File format usually: 1=Full, 0=Partial.
                            // So if "0" or "false", it IS partial.
                            if (fullVal === '0' || fullVal.toLowerCase() === 'false') {
                                isPartial = true;
                            }
                        }

                        // Missed Logic (New)
                        let isMissed = false;
                        if (idxMap.missed !== -1) {
                            const missedVal = row[idxMap.missed];
                            // If "1" or "true", it is missed
                            if (missedVal === '1' || missedVal.toLowerCase() === 'true') {
                                isMissed = true;
                            }
                        }

                        // Validation
                        if (!isNaN(odoRaw) && !isNaN(galRaw)) { // Allow negative/zero odo if user has old cars, app sorts it
                            // Check for duplicate (simple check by odo + date)
                            const isDup = vehicle.entries.some(e => e.odometer === odoRaw && e.date === finalDate);
                            
                            if (!isDup) {
                                vehicle.entries.push({
                                    id: Date.now() + i + Math.random(),
                                    date: finalDate,
                                    odometer: odoRaw,
                                    gallons: galRaw,
                                    price: isNaN(priceRaw) ? 0 : priceRaw,
                                    discount: 0,
                                    station: station,
                                    isPartial: isPartial,
                                    isMissed: isMissed
                                });
                                addedCount++;
                            }
                        }
                    } catch (err) {
                        console.warn("Skipped row", i, err);
                    }
                }

                if (addedCount > 0) {
                    vehicle.entries.sort((a, b) => b.odometer - a.odometer);
                    this.save();
                    uiManager.render();
                    uiManager.closeDataModal();
                    uiManager.showToast(`Success! Imported ${addedCount} logs.`);
                } else {
                    alert("No new valid entries found. (Duplicates are skipped).");
                }
            },

            save() {
                try {
                    localStorage.setItem('fuelFlowData', JSON.stringify(this.state));
                } catch (e) {
                    console.error("Save failed:", e);
                    alert("Could not save data. LocalStorage might be full or disabled.");
                }
            },

            clearCurrentVehicleData() {
                const vehicle = this.getActiveVehicle();
                if(confirm(`Clear all logs for ${vehicle.name}? This cannot be undone.`)) {
                    vehicle.entries = [];
                    this.save();
                    uiManager.render();
                    uiManager.closeDataModal();
                }
            },

            clearAllData() {
                if(confirm("DANGER: This will delete ALL vehicles and ALL history. Are you sure?")) {
                    localStorage.removeItem('fuelFlowData');
                    location.reload();
                }
            }
        };

        // --- UI Logic ---
        const uiManager = {
            currentGeoCoords: null,

            init() {
                document.getElementById('input-date').valueAsDate = new Date();
                document.getElementById('log-svc-date').valueAsDate = new Date();
                
                const inputs = ['input-gallons', 'input-price'];
                inputs.forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.updateModalPreview());
                });

                const discountInput = document.getElementById('input-discount');
                discountInput.addEventListener('input', (e) => {
                    let val = e.target.value.replace(/\D/g, '');
                    let numericVal = parseInt(val, 10);
                    if (isNaN(numericVal)) e.target.value = '0.00';
                    else e.target.value = (numericVal / 100).toFixed(2);
                    this.updateModalPreview();
                });

                document.getElementById('fuel-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleFormSubmit();
                });

                document.getElementById('car-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('input-car-name').value;
                    if(name) {
                        dataManager.addVehicle(name);
                        this.closeCarModal();
                    }
                });

                document.getElementById('service-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('input-svc-name').value;
                    const interval = document.getElementById('input-svc-interval').value;
                    const last = document.getElementById('input-svc-last').value;
                    const cost = document.getElementById('input-svc-initial-cost').value; // New Field

                    if(name && interval && last) {
                        dataManager.addService(name, interval, last, cost);
                        document.getElementById('service-form').reset();
                    }
                });

                // Log Service Form
                document.getElementById('log-service-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    // ID might be empty string for one-offs
                    const rawId = document.getElementById('log-svc-id').value;
                    const svcId = rawId ? parseInt(rawId) : null;
                    
                    const customName = document.getElementById('log-svc-custom-name').value;
                    const date = document.getElementById('log-svc-date').value;
                    const odo = document.getElementById('log-svc-odo').value;
                    const cost = document.getElementById('log-svc-cost').value;
                    const note = document.getElementById('log-svc-note').value;
                    
                    if (!svcId && !customName) {
                        alert("Please enter a description for this expense.");
                        return;
                    }

                    dataManager.performService(svcId, customName, date, odo, cost, note);
                    this.closeLogServiceModal();
                });
            },

            initVehicleSelect() {
                const select = document.getElementById('vehicle-select');
                select.innerHTML = '';
                dataManager.state.vehicles.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.id;
                    option.text = v.name;
                    option.selected = v.id == dataManager.state.activeVehicleId;
                    select.appendChild(option);
                });
            },

            // --- Service Modals & Renderers ---
            openServiceModal() {
                const modal = document.getElementById('service-modal');
                const content = document.getElementById('service-modal-content');
                
                this.switchServiceTab('active'); // Default view
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            },

            closeServiceModal() {
                const modal = document.getElementById('service-modal');
                const content = document.getElementById('service-modal-content');
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }, 300);
            },

            switchServiceTab(tabName) {
                const activeBtn = document.getElementById('tab-active');
                const historyBtn = document.getElementById('tab-history');
                const activeView = document.getElementById('view-active-services');
                const historyView = document.getElementById('view-history-services');

                if (tabName === 'active') {
                    activeBtn.className = "px-4 py-3 text-sm font-bold text-primary border-b-2 border-primary transition-colors";
                    historyBtn.className = "px-4 py-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-colors";
                    activeView.classList.remove('hidden');
                    historyView.classList.add('hidden');
                    this.renderServices();
                } else {
                    historyBtn.className = "px-4 py-3 text-sm font-bold text-primary border-b-2 border-primary transition-colors";
                    activeBtn.className = "px-4 py-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-colors";
                    historyView.classList.remove('hidden');
                    activeView.classList.add('hidden');
                    this.renderServiceHistory();
                }
            },

            renderServices() {
                const list = document.getElementById('active-services-list');
                const vehicle = dataManager.getActiveVehicle();
                
                if (!vehicle.services || vehicle.services.length === 0) {
                    list.innerHTML = `<div class="text-center text-slate-400 text-xs italic py-4">No services tracked yet.</div>`;
                    return;
                }

                list.innerHTML = '';
                const currentOdo = vehicle.entries.length > 0 ? vehicle.entries[0].odometer : 0;

                vehicle.services.forEach(s => {
                    const nextDue = s.lastOdo + s.interval;
                    const remaining = nextDue - currentOdo;
                    
                    // Color logic
                    let colorClass = "bg-emerald-50 border-emerald-200 text-emerald-700";
                    if (remaining < 0) colorClass = "bg-red-50 border-red-200 text-red-700";
                    else if (remaining < 500) colorClass = "bg-orange-50 border-orange-200 text-orange-700";

                    const item = document.createElement('div');
                    item.className = `p-3 rounded-lg border flex justify-between items-center ${colorClass}`;
                    item.innerHTML = `
                        <div>
                            <div class="font-bold text-sm">${s.name}</div>
                            <div class="text-xs opacity-80">${remaining < 0 ? 'Overdue by ' + Math.abs(remaining) : 'Due in ' + remaining} mi</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="uiManager.openLogServiceModal(${s.id}, '${s.name}', ${currentOdo})" class="bg-white/50 hover:bg-white px-3 py-1.5 rounded shadow-sm text-xs font-bold text-slate-700 border border-slate-200" title="Log Service Done">
                                Log
                            </button>
                            <button onclick="dataManager.deleteService(${s.id})" class="bg-white/50 hover:bg-white text-red-500 p-1.5 rounded shadow-sm text-xs" title="Delete">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            },

            renderServiceHistory() {
                const list = document.getElementById('service-history-list');
                const vehicle = dataManager.getActiveVehicle();
                
                if (!vehicle.maintenanceLogs || vehicle.maintenanceLogs.length === 0) {
                    list.innerHTML = `<div class="text-center text-slate-400 text-xs italic py-4">No maintenance history yet.</div>`;
                    return;
                }

                list.innerHTML = '';
                vehicle.maintenanceLogs.forEach(log => {
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100 text-sm";
                    item.innerHTML = `
                        <div>
                            <div class="font-semibold text-slate-700">${log.serviceName}</div>
                            <div class="text-xs text-slate-400">${new Date(log.date).toLocaleDateString()}  ${log.odometer.toLocaleString()} mi</div>
                            ${log.notes ? `<div class="text-[10px] text-slate-500 mt-0.5 italic">"${log.notes}"</div>` : ''}
                        </div>
                        <div class="font-bold text-slate-800">$${log.cost.toFixed(2)}</div>
                    `;
                    list.appendChild(item);
                });
            },

            openLogServiceModal(svcId, svcName, currentOdo) {
                const modal = document.getElementById('log-service-modal');
                const content = document.getElementById('log-service-content');
                const vehicle = dataManager.getActiveVehicle();
                
                // Default Odo if not passed (e.g. from one-off button)
                if (!currentOdo && vehicle.entries.length > 0) {
                    currentOdo = vehicle.entries[0].odometer;
                }

                document.getElementById('log-svc-id').value = svcId || "";
                document.getElementById('log-svc-date').valueAsDate = new Date();
                document.getElementById('log-svc-odo').value = currentOdo || "";
                document.getElementById('log-svc-cost').value = '';
                document.getElementById('log-svc-note').value = '';

                // Toggle UI based on mode (Scheduled vs One-Off)
                const customNameInput = document.getElementById('log-svc-custom-name');
                const staticNameDiv = document.getElementById('log-svc-static-name');

                if (svcId) {
                    // Scheduled Mode
                    customNameInput.classList.add('hidden');
                    customNameInput.required = false;
                    staticNameDiv.classList.remove('hidden');
                    staticNameDiv.innerText = "Completing: " + svcName;
                } else {
                    // One-Off Mode
                    staticNameDiv.classList.add('hidden');
                    customNameInput.classList.remove('hidden');
                    customNameInput.required = true;
                    customNameInput.value = "";
                    customNameInput.focus();
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            },

            closeLogServiceModal() {
                const modal = document.getElementById('log-service-modal');
                const content = document.getElementById('log-service-content');
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }, 300);
            },

            renderHealthCard() {
                const list = document.getElementById('health-list');
                const vehicle = dataManager.getActiveVehicle();
                const currentOdo = vehicle.entries.length > 0 ? vehicle.entries[0].odometer : 0;
                const badge = document.getElementById('service-badge');
                const totalCostEl = document.getElementById('health-total-cost');

                // Calculate total maintenance cost
                let totalMaintCost = 0;
                if (vehicle.maintenanceLogs) {
                    totalMaintCost = vehicle.maintenanceLogs.reduce((sum, log) => sum + (log.cost || 0), 0);
                }
                totalCostEl.innerText = `$${totalMaintCost.toLocaleString(undefined, {minimumFractionDigits: 2})} Maint.`;

                if (!vehicle.services || vehicle.services.length === 0) {
                    list.innerHTML = `<div class="text-center py-2 text-slate-400 text-xs italic">No service tasks configured. Tap Manage.</div>`;
                    badge.classList.add('hidden');
                    return;
                }

                list.innerHTML = '';
                let hasAlert = false;

                const sorted = [...vehicle.services].sort((a, b) => {
                    const remA = (a.lastOdo + a.interval) - currentOdo;
                    const remB = (b.lastOdo + b.interval) - currentOdo;
                    return remA - remB;
                });

                sorted.slice(0, 3).forEach(s => {
                    const nextDue = s.lastOdo + s.interval;
                    const remaining = nextDue - currentOdo;
                    const pct = Math.min(100, Math.max(0, (remaining / s.interval) * 100));
                    
                    let color = "bg-emerald-500";
                    if (remaining < 0) { color = "bg-red-500"; hasAlert = true; }
                    else if (remaining < 500) { color = "bg-orange-500"; hasAlert = true; }

                    const row = document.createElement('div');
                    row.className = "space-y-1";
                    row.innerHTML = `
                        <div class="flex justify-between text-xs font-medium text-slate-600">
                            <span>${s.name}</span>
                            <span class="${remaining < 0 ? 'text-red-500 font-bold' : ''}">${remaining < 0 ? Math.abs(remaining) + ' mi overdue' : remaining + ' mi left'}</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                            <div class="${color} h-1.5 rounded-full transition-all duration-500" style="width: ${remaining < 0 ? 100 : 100 - pct}%"></div>
                        </div>
                    `;
                    list.appendChild(row);
                });

                if (hasAlert) badge.classList.remove('hidden');
                else badge.classList.add('hidden');
            },

            // --- Geo & Standard Modals (Existing) ---
            detectLocation() {
                const btn = document.getElementById('btn-location');
                const ping = document.getElementById('loc-ping');
                const input = document.getElementById('input-station');
                
                if(!navigator.geolocation) {
                    this.showToast("Geolocation not supported");
                    return;
                }

                ping.classList.remove('hidden');
                btn.classList.add('text-primary');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.currentGeoCoords = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        
                        let nearest = null;
                        let minDist = Infinity;

                        dataManager.state.stations.forEach(st => {
                            if (st.lat && st.lon) {
                                const dist = this.getDistanceFromLatLonInKm(
                                    this.currentGeoCoords.lat, this.currentGeoCoords.lon,
                                    st.lat, st.lon
                                );
                                if (dist < minDist) {
                                    minDist = dist;
                                    nearest = st;
                                }
                            }
                        });

                        ping.classList.add('hidden');
                        btn.classList.remove('text-primary');

                        if (nearest && minDist < 0.5) {
                            input.value = nearest.name;
                            this.showToast(`Found: ${nearest.name}`);
                        } else {
                            this.showToast("Location captured");
                        }
                    },
                    (err) => {
                        ping.classList.add('hidden');
                        btn.classList.remove('text-primary');
                        this.showToast("Could not get location");
                    }
                );
            },

            getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                const R = 6371; 
                const dLat = this.deg2rad(lat2-lat1);
                const dLon = this.deg2rad(lon2-lon1); 
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                const d = R * c;
                return d;
            },

            // --- Modals ---
            openModal(existingEntry = null) {
                const modal = document.getElementById('entry-modal');
                const content = document.getElementById('modal-content');
                const activeCar = dataManager.getActiveVehicle();
                const titleEl = document.getElementById('modal-title');
                const submitBtn = document.getElementById('btn-submit');
                const deleteBtn = document.getElementById('btn-delete');

                document.getElementById('fuel-form').reset();
                this.currentGeoCoords = null;

                const dl = document.getElementById('station-list');
                dl.innerHTML = '';
                
                const stationMap = new Map(); 
                dataManager.state.vehicles.forEach(v => {
                    v.entries.forEach(e => {
                        if (e.station && e.station.trim()) {
                            const name = e.station.trim();
                            stationMap.set(name, (stationMap.get(name) || 0) + 1);
                        }
                    });
                });
                dataManager.state.stations.forEach(s => {
                    if (s.name && !stationMap.has(s.name)) {
                        stationMap.set(s.name, s.uses || 0);
                    }
                });
                const sortedNames = Array.from(stationMap.keys()).sort((a, b) => {
                    const freqDiff = stationMap.get(b) - stationMap.get(a);
                    if (freqDiff !== 0) return freqDiff;
                    return a.localeCompare(b);
                });
                sortedNames.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    dl.appendChild(opt);
                });

                if (existingEntry) {
                    titleEl.innerText = "Edit Fuel Entry";
                    submitBtn.innerText = "Update Entry";
                    deleteBtn.classList.remove('hidden');

                    document.getElementById('input-entry-id').value = existingEntry.id;
                    document.getElementById('input-date').value = existingEntry.date;
                    document.getElementById('input-odometer').value = existingEntry.odometer;
                    document.getElementById('input-gallons').value = existingEntry.gallons;
                    document.getElementById('input-price').value = existingEntry.price;
                    document.getElementById('input-discount').value = existingEntry.discount.toFixed(2);
                    document.getElementById('input-station').value = existingEntry.station || '';
                    document.getElementById('input-partial').checked = !!existingEntry.isPartial; 
                    document.getElementById('input-missed').checked = !!existingEntry.isMissed; // Load missed state
                    
                    this.updateModalPreview();

                } else {
                    titleEl.innerText = "New Fuel Entry";
                    submitBtn.innerText = "Save Entry";
                    deleteBtn.classList.add('hidden');
                    
                    document.getElementById('input-entry-id').value = "";
                    document.getElementById('input-date').valueAsDate = new Date();
                    document.getElementById('input-discount').value = "0.00";
                    document.getElementById('input-partial').checked = false;
                    document.getElementById('input-missed').checked = false;
                    document.getElementById('preview-total').innerText = "$0.00";

                    if(activeCar.entries.length > 0) {
                        document.getElementById('input-odometer').value = activeCar.entries[0].odometer;
                    }
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            },

            closeModal() {
                const modal = document.getElementById('entry-modal');
                const content = document.getElementById('modal-content');
                
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                
                setTimeout(() => {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                    this.currentGeoCoords = null;
                }, 300);
            },

            deleteEntry() {
                const id = document.getElementById('input-entry-id').value;
                if (id && confirm("Are you sure you want to delete this entry?")) {
                    dataManager.deleteEntry(parseInt(id));
                    this.closeModal();
                }
            },

            openCarModal() {
                const modal = document.getElementById('car-modal');
                const content = document.getElementById('car-modal-content');
                
                document.getElementById('input-car-name').value = '';
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
                setTimeout(() => document.getElementById('input-car-name').focus(), 100);
            },

            closeCarModal() {
                const modal = document.getElementById('car-modal');
                const content = document.getElementById('car-modal-content');
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }, 300);
            },

            openDataModal() {
                const modal = document.getElementById('data-modal');
                const content = document.getElementById('data-modal-content');
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            },

            closeDataModal() {
                const modal = document.getElementById('data-modal');
                const content = document.getElementById('data-modal-content');
                
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                
                setTimeout(() => {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }, 300);
            },

            updateModalPreview() {
                const gals = parseFloat(document.getElementById('input-gallons').value) || 0;
                const price = parseFloat(document.getElementById('input-price').value) || 0;
                const discount = parseFloat(document.getElementById('input-discount').value) || 0;
                
                const finalPrice = Math.max(0, price - discount);
                const total = finalPrice * gals;
                
                const totalEl = document.getElementById('preview-total');
                totalEl.innerText = `$${total.toFixed(2)}`;
                
                if(discount > 0) {
                    totalEl.innerHTML = `$${total.toFixed(2)} <span class='text-xs text-emerald-500 font-normal ml-1'>(-$${(discount*gals).toFixed(2)})</span>`;
                }
            },

            handleFormSubmit() {
                const idInput = document.getElementById('input-entry-id').value;
                const date = document.getElementById('input-date').value;
                const odometer = parseFloat(document.getElementById('input-odometer').value);
                const gallons = parseFloat(document.getElementById('input-gallons').value);
                const price = parseFloat(document.getElementById('input-price').value);
                const discount = parseFloat(document.getElementById('input-discount').value) || 0;
                const station = document.getElementById('input-station').value.trim();
                const isPartial = document.getElementById('input-partial').checked;
                const isMissed = document.getElementById('input-missed').checked;

                const activeCar = dataManager.getActiveVehicle();

                if (!idInput && activeCar.entries.length > 0) {
                    // No enforcement, just allow sorting by app. 
                    // Warn if significantly LOWER than max? Nah, let user backlog freely.
                }

                const entry = {
                    id: idInput ? parseInt(idInput) : Date.now(),
                    date,
                    odometer,
                    gallons,
                    price,
                    discount,
                    station: station || null,
                    isPartial,
                    isMissed
                };

                dataManager.upsertEntry(entry, this.currentGeoCoords);
                this.closeModal();
            },

            showToast(msg) {
                const toast = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                toast.classList.remove('translate-y-[-150%]');
                toast.classList.add('translate-y-5');
                setTimeout(() => {
                    toast.classList.remove('translate-y-5');
                    toast.classList.add('translate-y-[-150%]');
                }, 3000);
            },

            render() {
                const activeCar = dataManager.getActiveVehicle();
                if(!activeCar) return;

                document.getElementById('vehicle-select').value = activeCar.id;

                this.renderStats(activeCar.entries);
                this.renderHistory(activeCar.entries);
                this.renderHealthCard();
            },

            calcLogStats(index, entries) {
                const entry = entries[index];
                
                // Can't calculate MPG if this entry is partial (loop not closed)
                // OR if this entry is marked as "Missed Previous" (gap behind it)
                if (entry.isPartial) return null; 
                if (entry.isMissed) return null; 

                // Find previous FULL fill-up
                let prevFullIndex = -1;
                for (let i = index + 1; i < entries.length; i++) {
                    // If we hit a "Missed" entry during scan, the chain is broken
                    if (entries[i].isMissed) {
                        break; 
                    }
                    if (!entries[i].isPartial) {
                        prevFullIndex = i;
                        break;
                    }
                }

                if (prevFullIndex === -1) return null; 

                const prevFullEntry = entries[prevFullIndex];
                const distance = entry.odometer - prevFullEntry.odometer;
                
                let gallonsUsed = entry.gallons;
                for (let i = index + 1; i < prevFullIndex; i++) {
                    gallonsUsed += entries[i].gallons;
                }

                return {
                    mpg: distance / gallonsUsed,
                    distance: distance,
                    gallons: gallonsUsed
                };
            },

            renderStats(entries) {
                const defaults = {
                    kpi: "--", kpiNum: "0", trend: "", money: "$0.00", 
                    table: "--", tableZero: "0", tableMoney: "$0.00"
                };
                
                document.getElementById('stat-mpg').innerText = defaults.kpi;
                document.getElementById('stat-cpm').innerText = defaults.kpi;
                document.getElementById('stat-saved').innerText = "0.00";
                document.getElementById('stat-dist').innerText = defaults.kpiNum;
                document.getElementById('stat-mpg-trend').innerHTML = "";
                
                document.getElementById('table-total-gallons').innerText = "0.00";
                document.getElementById('table-avg-price').innerText = defaults.kpi;
                
                document.getElementById('table-month-dist').innerText = "0 mi";
                document.getElementById('table-month-cost').innerText = defaults.tableMoney;
                document.getElementById('table-month-fillups').innerText = "0";
                document.getElementById('table-month-mpg').innerText = defaults.table;

                document.getElementById('table-ytd-dist').innerText = "0 mi";
                document.getElementById('table-ytd-cost').innerText = defaults.tableMoney;
                document.getElementById('table-ytd-fillups').innerText = "0";
                document.getElementById('table-ytd-mpg').innerText = defaults.table;

                document.getElementById('insight-best-mpg').innerText = defaults.table;
                document.getElementById('insight-best-range').innerText = "0 mi";
                document.getElementById('insight-freq').innerText = "--";
                document.getElementById('insight-proj-cost').innerText = defaults.tableMoney;

                if (entries.length === 0) {
                    document.getElementById('table-fillups').innerText = "0";
                    return;
                }

                let totalGallonsAllTime = 0;
                let totalCostAllTime = 0;
                let totalDiscountDollars = 0;

                entries.forEach(e => {
                    const finalP = Math.max(0, e.price - e.discount);
                    const cost = finalP * e.gallons;
                    
                    totalCostAllTime += cost;
                    totalDiscountDollars += (e.discount * e.gallons);
                    totalGallonsAllTime += e.gallons;
                });

                const weightedAvgPrice = totalGallonsAllTime > 0 ? (totalCostAllTime / totalGallonsAllTime) : 0;

                document.getElementById('table-total-gallons').innerText = totalGallonsAllTime.toFixed(1) + " gal";
                document.getElementById('table-avg-price').innerText = '$' + weightedAvgPrice.toFixed(2);
                document.getElementById('stat-saved').innerText = totalDiscountDollars.toFixed(2);
                document.getElementById('table-fillups').innerText = entries.length;

                if (entries.length < 2) return;

                // Total Distance KPI (Just Odo - Odo)
                const totalDist = entries[0].odometer - entries[entries.length - 1].odometer;
                
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const dayOfYear = Math.floor((now - new Date(currentYear, 0, 0)) / 1000 / 60 / 60 / 24);

                let monthDist = 0;
                let monthCost = 0;
                let monthFillups = 0;
                let monthGallons = 0;

                let ytdDist = 0;
                let ytdCost = 0;
                let ytdFillups = 0;
                let ytdGallons = 0;

                let bestMpg = 0;
                let bestRange = 0;

                // Sum for Lifetime Valid MPG Calculation
                let lifetimeValidDist = 0;
                let lifetimeValidGallons = 0;

                for(let i = 0; i < entries.length - 1; i++) {
                    const currentEntry = entries[i];
                    const nextEntry = entries[i+1];
                    // Simple dist between points for table metrics
                    const tripDist = currentEntry.odometer - nextEntry.odometer;
                    const entryDate = new Date(currentEntry.date);
                    
                    // Calc Stats for this entry using smart logic (validates chains)
                    const stats = this.calcLogStats(i, entries);
                    
                    if (stats) {
                        if (stats.mpg > bestMpg) bestMpg = stats.mpg;
                        if (stats.distance > bestRange) bestRange = stats.distance;
                        
                        // Add to lifetime valid sum
                        lifetimeValidDist += stats.distance;
                        lifetimeValidGallons += stats.gallons;
                    }

                    // Period Stats: Use simple accumulation for Cost/Count
                    // For Dist/MPG, ideally use valid chains, but simpler to sum tripDist 
                    // BUT excluding Missed segments for distance accuracy
                    
                    if (currentEntry.isMissed) {
                        // This gap is invalid distance
                    } else {
                        // Valid-ish gap
                        if (entryDate.getFullYear() === currentYear) {
                            ytdDist += tripDist;
                            const cost = (Math.max(0, currentEntry.price - currentEntry.discount) * currentEntry.gallons);
                            ytdCost += cost;
                            ytdFillups++;
                            ytdGallons += currentEntry.gallons; // This is loose for period MPG, ok for approx

                            if (entryDate.getMonth() === currentMonth) {
                                monthDist += tripDist;
                                monthCost += cost;
                                monthFillups++;
                                monthGallons += currentEntry.gallons;
                            }
                        }
                    }
                }

                let projectedCost = 0;
                if (ytdCost > 0 && dayOfYear > 0) {
                    const dailyAvg = ytdCost / dayOfYear;
                    projectedCost = dailyAvg * 365;
                }

                let stopFreq = 0;
                if (entries.length > 1) {
                    const newestDate = new Date(entries[0].date);
                    const oldestDate = new Date(entries[entries.length - 1].date);
                    const totalDays = (newestDate - oldestDate) / (1000 * 60 * 60 * 24);
                    stopFreq = totalDays / (entries.length - 1);
                }

                // Lifetime Avg MPG (Valid Dist / Valid Gal)
                const avgMpg = lifetimeValidGallons > 0 ? (lifetimeValidDist / lifetimeValidGallons) : 0;
                
                // Cost per Mile (Total Cost / Total Dist) - keeps simple Approx
                const costPerMile = totalDist > 0 ? (totalCostAllTime / totalDist) : 0; 

                const monthMpg = monthGallons > 0 ? (monthDist / monthGallons) : 0;
                const ytdMpg = ytdGallons > 0 ? (ytdDist / ytdGallons) : 0;

                document.getElementById('stat-mpg').innerText = avgMpg.toFixed(1);
                document.getElementById('stat-cpm').innerText = costPerMile.toFixed(2);
                document.getElementById('stat-dist').innerText = totalDist.toLocaleString();

                document.getElementById('table-month-dist').innerText = monthDist.toLocaleString() + " mi";
                document.getElementById('table-month-cost').innerText = "$" + monthCost.toFixed(2);
                document.getElementById('table-month-fillups').innerText = monthFillups;
                document.getElementById('table-month-mpg').innerText = monthMpg > 0 ? monthMpg.toFixed(1) : '--';

                document.getElementById('table-ytd-dist').innerText = ytdDist.toLocaleString() + " mi";
                document.getElementById('table-ytd-cost').innerText = "$" + ytdCost.toFixed(2);
                document.getElementById('table-ytd-fillups').innerText = ytdFillups;
                document.getElementById('table-ytd-mpg').innerText = ytdMpg > 0 ? ytdMpg.toFixed(1) : '--';

                document.getElementById('insight-best-mpg').innerText = bestMpg > 0 ? bestMpg.toFixed(1) : '--';
                document.getElementById('insight-best-range').innerText = bestRange > 0 ? (bestRange + " mi") : '--';
                document.getElementById('insight-freq').innerText = stopFreq > 0 ? ("Every " + Math.round(stopFreq) + " days") : '--';
                document.getElementById('insight-proj-cost').innerText = projectedCost > 0 ? ("$" + projectedCost.toLocaleString(undefined, {maximumFractionDigits: 0})) : '--';

                let lastMpgVal = 0;
                for(let i=0; i<entries.length; i++) {
                    const stats = this.calcLogStats(i, entries);
                    if (stats) {
                        lastMpgVal = stats.mpg;
                        break;
                    }
                }
                
                const diff = lastMpgVal - avgMpg;
                const trendEl = document.getElementById('stat-mpg-trend');
                if (lastMpgVal > 0) {
                    if(diff > 0) {
                        trendEl.innerHTML = `<span class='text-emerald-500 bg-emerald-50 px-1.5 py-0.5 rounded'>+${diff.toFixed(1)}</span> vs avg`;
                    } else {
                        trendEl.innerHTML = `<span class='text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded'>${diff.toFixed(1)}</span> vs avg`;
                    }
                }
            },

            renderHistory(entries) {
                const list = document.getElementById('history-list');
                document.getElementById('entry-count').innerText = `${entries.length} entries`;

                if (entries.length === 0) {
                    list.innerHTML = `<div class="text-center py-10 text-slate-400"><i class="ph ph-notebook text-4xl mb-2"></i><p class="text-sm">No entries yet.</p></div>`;
                    return;
                }

                list.innerHTML = '';

                entries.forEach((entry, index) => {
                    let mpgDisplay = '-.-';
                    let milesDisplay = '';
                    
                    const stats = this.calcLogStats(index, entries);

                    if (entry.isMissed) {
                        mpgDisplay = `<span class="font-bold text-red-500 text-xs bg-red-50 px-2 py-0.5 rounded-full">Missed Prev</span>`;
                        if (index < entries.length - 1) {
                            const dist = entry.odometer - entries[index+1].odometer;
                            milesDisplay = `+${dist} mi`;
                        }
                    } else if (entry.isPartial) {
                        mpgDisplay = `<span class="font-bold text-orange-500 text-xs bg-orange-50 px-2 py-0.5 rounded-full">Partial</span>`;
                        if (index < entries.length - 1) {
                            const dist = entry.odometer - entries[index+1].odometer;
                            milesDisplay = `+${dist} mi`;
                        }
                    } else if (stats) {
                        mpgDisplay = `<span class="font-bold text-slate-700">${stats.mpg.toFixed(1)}</span> <span class="text-[10px] text-slate-400">MPG</span>`;
                        milesDisplay = `+${stats.distance} mi`;
                    } else {
                        mpgDisplay = `<span class="font-bold text-blue-500 text-xs bg-blue-50 px-2 py-0.5 rounded-full">Baseline</span>`;
                    }

                    const finalPrice = entry.price - entry.discount;
                    const totalCost = finalPrice * entry.gallons;
                    
                    const discountBadge = entry.discount > 0 
                        ? `<span class="text-[10px] text-emerald-600 bg-emerald-50 px-1.5 rounded inline-flex items-center gap-1 ml-1"><i class="ph-fill ph-tag"></i>Saved $${(entry.discount*entry.gallons).toFixed(2)}</span>` 
                        : '';

                    const stationDisplay = entry.station 
                        ? `<div class="text-[11px] text-slate-500 flex items-center gap-1 mt-0.5"><i class="ph-fill ph-map-pin text-primary/70"></i>${entry.station}</div>`
                        : '';

                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center p-3 hover:bg-slate-50 cursor-pointer rounded-lg transition-colors border-b border-slate-50 last:border-0 slide-in';
                    row.style.animationDelay = `${index * 0.05}s`;
                    
                    row.onclick = () => uiManager.openModal(entry);
                    
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-50 text-blue-500 w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs flex-col leading-none shrink-0">
                                <span>${new Date(entry.date).getDate()}</span>
                                <span class="text-[8px] uppercase">${new Date(entry.date).toLocaleDateString(undefined,{month:'short'})}</span>
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-slate-700">$${totalCost.toFixed(2)} ${discountBadge}</div>
                                <div class="text-xs text-slate-400">${entry.gallons.toFixed(3)} gal @ $${finalPrice.toFixed(3)}</div>
                                ${stationDisplay}
                            </div>
                        </div>
                        <div class="text-right whitespace-nowrap">
                            <div class="text-lg leading-tight">${mpgDisplay}</div>
                            <div class="text-xs text-slate-400 mt-1">${milesDisplay}</div>
                        </div>
                    `;
                    list.appendChild(row);
                });
            }
        };

        // --- Start App ---
        document.addEventListener('DOMContentLoaded', () => {
            uiManager.init();
            dataManager.init();
        });

    </script>
</body>
</html>